{% extends 'web/base.html' %}
{% block content %}

<style>
    #map { height: 100vh; width: 100%; }

    .info-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-family: sans-serif;
      width: 250px;
    }
    .control-row { margin-bottom: 8px; }
    .btn { padding: 6px 10px; cursor: pointer; border-radius: 4px; border: 1px solid #888; background: #f5f5f5; }
</style>

<div id="map"></div>

<div class="info-panel" id="info">
    <div><strong>SafePath</strong></div>
    <div class="control-row">
        <button id="use-default" class="btn">Use default destination</button>
        <button id="clear" class="btn">Clear</button>
    </div>
    <div><small>Click the map to choose a destination. Your location will be used as the start.</small></div>
    <hr/>
    <div id="status">Waiting for location...</div>
    <ul id="stats" style="padding-left: 16px;"></ul>
</div>

<script>
    const SAFE_ROUTE_URL = "/api/safe-route/";

    const map = L.map('map').setView([28.6139, 77.2090], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let userMarker = null;
    let destMarker = null;
    let originalLayer = null;
    let safeLayer = null;

    const statusEl = document.getElementById('status');
    const statsEl = document.getElementById('stats');

    function setStatus(text){
      statusEl.textContent = text;
    }

    function setUserLocation(lat, lon){
      if(userMarker) userMarker.setLatLng([lat, lon]);
      else userMarker = L.marker([lat, lon], {title: "You"}).addTo(map);
      map.setView([lat, lon], 15);
      setStatus("Location acquired.");
    }

    // Geolocation
    if (navigator.geolocation) {
      setStatus("Requesting location...");
      navigator.geolocation.getCurrentPosition((pos) => {
        setUserLocation(pos.coords.latitude, pos.coords.longitude);
      }, (err) => {
        console.warn("geolocation error", err);
        setStatus("Could not get location. Click map to set both start/destination.");
      }, {enableHighAccuracy: true});
    } else {
      setStatus("Geolocation not supported.");
    }

    // Map click
    map.on('click', async function(e){
      const destLat = e.latlng.lat;
      const destLon = e.latlng.lng;

      if(destMarker) destMarker.setLatLng(e.latlng);
      else destMarker = L.marker(e.latlng).addTo(map);

      let startLat, startLon;
      if(userMarker) {
        const p = userMarker.getLatLng();
        startLat = p.lat; startLon = p.lng;
      } else {
        startLat = destLat - 0.005;
        startLon = destLon - 0.005;
        setUserLocation(startLat, startLon);
      }

      await requestSafeRouteAndDraw(startLat, startLon, destLat, destLon);
    });

    // Default destination
    document.getElementById('use-default').addEventListener('click', async function(){
      const defaultDest = [28.6205, 77.2208];
      if(!userMarker) {
        setStatus("No user location â€” click map first.");
        return;
      }
      const p = userMarker.getLatLng();
      await requestSafeRouteAndDraw(p.lat, p.lng, defaultDest[0], defaultDest[1]);

      if(destMarker) destMarker.setLatLng(defaultDest);
      else destMarker = L.marker(defaultDest).addTo(map);
    });

    // Clear
    document.getElementById('clear').addEventListener('click', function(){
      if(originalLayer) { map.removeLayer(originalLayer); originalLayer = null; }
      if(safeLayer) { map.removeLayer(safeLayer); safeLayer = null; }
      statsEl.innerHTML = '';
      setStatus("Cleared.");
    });

    async function requestSafeRouteAndDraw(startLat, startLon, endLat, endLon) {
      setStatus("Fetching routes...");
      const url = `${SAFE_ROUTE_URL}?start_lat=${startLat}&start_lon=${startLon}&end_lat=${endLat}&end_lon=${endLon}`;
      try {
        const res = await fetch(url);
        if(!res.ok) throw new Error("Server error " + res.status);
        const data = await res.json();

        if(originalLayer) map.removeLayer(originalLayer);
        originalLayer = L.polyline(data.original_route.map(p => [p[0], p[1]]), {
          weight: 6, opacity: 0.5
        }).addTo(map);

        if(safeLayer) map.removeLayer(safeLayer);
        safeLayer = L.polyline(data.safe_path.map(p => [p[0], p[1]]), {
          weight: 6, opacity: 1
        }).addTo(map);

        const allPoints = data.original_route.concat(data.safe_path).map(p => [p[0], p[1]]);
        map.fitBounds(allPoints, {padding: [40, 40]});

        statsEl.innerHTML = '';
        const li = (txt) => { const el = document.createElement('li'); el.textContent = txt; return el; };
        statsEl.appendChild(li(`Segments (OSRM): ${data.segments}`));
        statsEl.appendChild(li(`Graph nodes: ${data.nodes}`));
        statsEl.appendChild(li(`Distance (m): ${Math.round(data.distance_meters)}`));
        statsEl.appendChild(li(`Avg segment risk: ${Number(data.avg_risk).toFixed(3)}`));

        setStatus("Route rendered. Original = gray, safe = green.");

      } catch (err) {
        console.error(err);
        setStatus("Error: " + err.message);
      }
    }
</script>

{% endblock %}

